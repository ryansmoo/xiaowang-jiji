<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ±ªè¨˜è¨˜ - ä»»å‹™ç·¨è¼¯</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #DDA368 0%, #F4D03F 100%);
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .header-icon {
            font-size: 50px;
            margin-bottom: 10px;
        }
        
        .header-title {
            font-size: 24px;
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 5px;
        }
        
        .header-subtitle {
            font-size: 14px;
            color: #A0522D;
            opacity: 0.8;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 16px;
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 8px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #DDA368;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background: white;
            color: #333;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #8B4513;
            box-shadow: 0 0 5px rgba(139, 69, 19, 0.3);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #8B4513;
            color: white;
        }
        
        .btn-primary:hover {
            background: #A0522D;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #DDD;
            color: #666;
        }
        
        .btn-secondary:hover {
            background: #CCC;
            transform: translateY(-2px);
        }
        
        .loading {
            text-align: center;
            color: #8B4513;
            margin: 20px 0;
        }
        
        .error {
            color: #FF6347;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-icon">âœï¸</div>
            <div class="header-title">ä»»å‹™ç·¨è¼¯</div>
            <div class="header-subtitle">ğŸ• å°æ±ªè¨˜è¨˜ç‚ºæ‚¨æœå‹™</div>
        </div>
        
        <div id="loading" class="loading">
            <div>ğŸ¾ è¼‰å…¥ä»»å‹™è³‡æ–™ä¸­...</div>
        </div>
        
        <form id="taskForm" style="display: none;">
            <div class="form-group">
                <label class="form-label" for="taskName">ä»»å‹™åç¨±</label>
                <input type="text" id="taskName" class="form-input" placeholder="è¼¸å…¥ä»»å‹™åç¨±..." maxlength="50">
                <div id="taskNameError" class="error"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="taskNote">ä»»å‹™å‚™è¨»</label>
                <textarea id="taskNote" class="form-input form-textarea" placeholder="è¼¸å…¥ä»»å‹™å‚™è¨»..." maxlength="200"></textarea>
                <div id="taskNoteError" class="error"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="taskTime">ä»»å‹™æ™‚é–“</label>
                <input type="datetime-local" id="taskTime" class="form-input" placeholder="é¸æ“‡ä»»å‹™æ—¥æœŸå’Œæ™‚é–“">
                <div id="taskTimeError" class="error"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="taskReminder">ä»»å‹™æé†’</label>
                <select id="taskReminder" class="form-input">
                    <option value="">ä¸ä½¿ç”¨æé†’</option>
                    <option value="10">10åˆ†é˜å‰</option>
                    <option value="30">30åˆ†é˜å‰</option>
                    <option value="60">60åˆ†é˜å‰</option>
                    <option value="custom">è‡ªè¨‚</option>
                </select>
                <input type="number" id="customReminder" class="form-input" placeholder="è¼¸å…¥åˆ†é˜æ•¸" style="display: none; margin-top: 8px;" min="1" max="1440">
                <div id="taskReminderError" class="error"></div>
            </div>
            
            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="cancelEdit()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveTask()">ä¿å­˜</button>
            </div>
        </form>
    </div>

    <script>
        let currentTask = null;
        
        // è™•ç†æé†’é¸æ“‡å™¨è®ŠåŒ–
        function handleReminderChange() {
            const reminderSelect = document.getElementById('taskReminder');
            const customReminderInput = document.getElementById('customReminder');
            
            if (reminderSelect.value === 'custom') {
                customReminderInput.style.display = 'block';
            } else {
                customReminderInput.style.display = 'none';
                customReminderInput.value = '';
            }
        }
        
        // ç•¶é é¢è¼‰å…¥å®Œæˆå¾Œï¼Œç¶å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('taskReminder').addEventListener('change', handleReminderChange);
        });
        
        // åˆå§‹åŒ– LIFF
        document.addEventListener('DOMContentLoaded', function() {
            const liffId = '2007976732-1kEGwX34';
            
            liff.init({
                liffId: liffId
            }).then(() => {
                console.log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
                loadTaskData();
            }).catch((err) => {
                console.error('âŒ LIFF åˆå§‹åŒ–å¤±æ•—:', err);
                showError('LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿ');
            });
        });
        
        // è¼‰å…¥ä»»å‹™è³‡æ–™
        function loadTaskData() {
            try {
                // å¾ URL åƒæ•¸ç²å–ä»»å‹™ ID
                const urlParams = new URLSearchParams(window.location.search);
                const taskId = urlParams.get('taskId');
                
                if (!taskId) {
                    showError('ç¼ºå°‘ä»»å‹™ ID');
                    return;
                }
                
                console.log('ğŸ“‹ è¼‰å…¥ä»»å‹™ ID:', taskId);
                
                // å¾ API ç²å–æœ€æ–°çš„ä»»å‹™è³‡æ–™
                fetch(`/api/task/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('âœ… å¾ API è¼‰å…¥ä»»å‹™è³‡æ–™:', data.task);
                            
                            currentTask = {
                                id: data.task.id,
                                name: data.task.name,
                                note: data.task.note || '',
                                time: data.task.time || '',
                                reminder: data.task.reminder || ''
                            };
                            
                            // å¡«å…¥è¡¨å–®è³‡æ–™
                            document.getElementById('taskName').value = currentTask.name;
                            document.getElementById('taskNote').value = currentTask.note;
                            document.getElementById('taskTime').value = currentTask.time;
                            
                            // è¨­å®šæé†’é¸æ“‡å™¨
                            const reminderValue = currentTask.reminder;
                            if (reminderValue && !['10', '30', '60'].includes(reminderValue)) {
                                // è‡ªè¨‚åˆ†é˜æ•¸
                                document.getElementById('taskReminder').value = 'custom';
                                document.getElementById('customReminder').value = reminderValue;
                                document.getElementById('customReminder').style.display = 'block';
                            } else {
                                document.getElementById('taskReminder').value = reminderValue;
                            }
                            
                            // é¡¯ç¤ºè¡¨å–®ï¼Œéš±è—è¼‰å…¥ç•«é¢
                            document.getElementById('loading').style.display = 'none';
                            document.getElementById('taskForm').style.display = 'block';
                        } else {
                            console.error('âŒ API å›å‚³éŒ¯èª¤:', data.message);
                            showError('æ‰¾ä¸åˆ°æŒ‡å®šä»»å‹™');
                        }
                    })
                    .catch(error => {
                        console.error('âŒ API è«‹æ±‚å¤±æ•—:', error);
                        // é™ç´šè™•ç†ï¼šå˜—è©¦ä½¿ç”¨ URL åƒæ•¸
                        const taskName = urlParams.get('taskName') || '';
                        const taskNote = urlParams.get('taskNote') || '';
                        const taskTime = urlParams.get('taskTime') || '';
                        const taskReminder = urlParams.get('taskReminder') || '';
                        
                        console.log('âš ï¸ é™ç´šä½¿ç”¨ URL åƒæ•¸:', { taskId, taskName, taskNote, taskTime, taskReminder });
                        
                        currentTask = {
                            id: taskId,
                            name: decodeURIComponent(taskName),
                            note: decodeURIComponent(taskNote),
                            time: decodeURIComponent(taskTime),
                            reminder: decodeURIComponent(taskReminder)
                        };
                        
                        // å¡«å…¥è¡¨å–®è³‡æ–™
                        document.getElementById('taskName').value = currentTask.name;
                        document.getElementById('taskNote').value = currentTask.note;
                        document.getElementById('taskTime').value = currentTask.time;
                        
                        // è¨­å®šæé†’é¸æ“‡å™¨
                        const reminderValue = currentTask.reminder;
                        if (reminderValue && !['10', '30', '60'].includes(reminderValue)) {
                            document.getElementById('taskReminder').value = 'custom';
                            document.getElementById('customReminder').value = reminderValue;
                            document.getElementById('customReminder').style.display = 'block';
                        } else {
                            document.getElementById('taskReminder').value = reminderValue;
                        }
                        
                        // é¡¯ç¤ºè¡¨å–®ï¼Œéš±è—è¼‰å…¥ç•«é¢
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('taskForm').style.display = 'block';
                    });
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥ä»»å‹™è³‡æ–™å¤±æ•—:', error);
                showError('è¼‰å…¥ä»»å‹™è³‡æ–™å¤±æ•—');
            }
        }
        
        // ä¿å­˜ä»»å‹™
        function saveTask() {
            const taskName = document.getElementById('taskName').value.trim();
            const taskNote = document.getElementById('taskNote').value.trim();
            const taskTime = document.getElementById('taskTime').value;
            const reminderSelect = document.getElementById('taskReminder').value;
            const customReminderValue = document.getElementById('customReminder').value;
            
            // è¨ˆç®—æœ€çµ‚çš„æé†’å€¼
            let taskReminder = '';
            if (reminderSelect === 'custom' && customReminderValue) {
                taskReminder = customReminderValue;
            } else if (reminderSelect && reminderSelect !== 'custom') {
                taskReminder = reminderSelect;
            }
            
            // æ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤è¨Šæ¯
            document.getElementById('taskNameError').textContent = '';
            document.getElementById('taskNoteError').textContent = '';
            document.getElementById('taskTimeError').textContent = '';
            document.getElementById('taskReminderError').textContent = '';
            
            // é©—è­‰
            if (!taskName) {
                document.getElementById('taskNameError').textContent = 'è«‹è¼¸å…¥ä»»å‹™åç¨±';
                return;
            }
            
            if (taskName.length > 50) {
                document.getElementById('taskNameError').textContent = 'ä»»å‹™åç¨±ä¸èƒ½è¶…é50å€‹å­—ç¬¦';
                return;
            }
            
            if (taskNote.length > 200) {
                document.getElementById('taskNoteError').textContent = 'å‚™è¨»ä¸èƒ½è¶…é200å€‹å­—ç¬¦';
                return;
            }
            
            // é©—è­‰è‡ªè¨‚æé†’
            if (reminderSelect === 'custom') {
                if (!customReminderValue || customReminderValue < 1 || customReminderValue > 1440) {
                    document.getElementById('taskReminderError').textContent = 'è‡ªè¨‚æé†’æ™‚é–“éœ€è¦åœ¨1-1440åˆ†é˜ä¹‹é–“';
                    return;
                }
            }
            
            // æ›´æ–°ä»»å‹™è³‡æ–™
            currentTask.name = taskName;
            currentTask.note = taskNote;
            currentTask.time = taskTime;
            currentTask.reminder = taskReminder;
            
            console.log('ğŸ’¾ ä¿å­˜ä»»å‹™:', currentTask);
            
            // ç™¼é€ API è«‹æ±‚åˆ°å¾Œç«¯ä¿å­˜ä»»å‹™
            fetch(`/api/tasks/${currentTask.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    taskName: taskName,
                    taskNote: taskNote,
                    taskTime: taskTime,
                    taskReminder: taskReminder
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('âœ… ä»»å‹™ä¿å­˜æˆåŠŸ');
                    alert('âœ… ä»»å‹™å·²ä¿å­˜æˆåŠŸï¼');
                    closeLiff();
                } else {
                    console.error('âŒ ä»»å‹™ä¿å­˜å¤±æ•—:', data.message);
                    alert('âŒ ä¿å­˜å¤±æ•—: ' + data.message);
                }
            })
            .catch(error => {
                console.error('âŒ API è«‹æ±‚å¤±æ•—:', error);
                alert('âŒ ä¿å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
            });
        }
        
        // å–æ¶ˆç·¨è¼¯
        function cancelEdit() {
            closeLiff();
        }
        
        // é¡¯ç¤ºéŒ¯èª¤
        function showError(message) {
            document.getElementById('loading').innerHTML = `
                <div style="color: #FF6347;">âŒ ${message}</div>
                <button onclick="closeLiff()" style="margin-top: 15px; padding: 10px 20px; border: none; border-radius: 5px; background: #DDA368; color: white; cursor: pointer;">é—œé–‰</button>
            `;
        }
        
        // é—œé–‰ LIFF è¦–çª—
        function closeLiff() {
            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.close();
            }
        }
    </script>
</body>
</html>