<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小汪記記 - 個人帳戶</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #DDA368 0%, #F4D03F 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #DDA368 0%, #F4D03F 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            margin-bottom: 15px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .username {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .user-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            padding: 25px;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #DDA368;
        }
        
        .stat-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #DDA368;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .feature-list {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .feature-item:last-child {
            border-bottom: none;
        }
        
        .feature-icon {
            font-size: 20px;
            margin-right: 15px;
            width: 30px;
            text-align: center;
        }
        
        .feature-text {
            flex: 1;
            font-size: 16px;
            color: #333;
        }
        
        .feature-status {
            font-size: 12px;
            color: #28a745;
            background: #d4edda;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .close-btn {
            background: linear-gradient(135deg, #DDA368 0%, #F4D03F 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: bold;
        }
        
        .close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .user-info {
            background: #e3f2fd;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #2196f3;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info-label {
            color: #666;
            font-weight: 500;
        }
        
        .info-value {
            color: #333;
            font-weight: bold;
        }
        
        /* 會員系統樣式 */
        .member-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .member-basic {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .member-premium {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .member-vip {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .login-prompt {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .login-btn {
            background: #00C300;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            background: #00B300;
            transform: translateY(-1px);
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="profile-avatar" id="userAvatar">🐕</div>
            <div class="username" id="userName">載入中...
                <span class="member-badge member-basic" id="memberBadge" style="display: none;">基礎會員</span>
                <button class="logout-btn" id="logoutBtn" style="display: none;" onclick="logoutMember()">登出</button>
            </div>
            <div class="user-subtitle" id="userSubtitle">小汪記記的好朋友</div>
        </div>
        
        <div class="content">
            <!-- 登入提示區塊 -->
            <div class="login-prompt" id="loginPrompt" style="display: none;">
                <div style="font-size: 20px; margin-bottom: 10px;">🐕</div>
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">成為小汪記記會員</div>
                <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                    登入後享受個人化功能和資料同步
                </div>
                <a href="/login" class="login-btn">🔐 立即登入</a>
            </div>
            
            <!-- 用戶資訊區塊 -->
            <div class="user-info" id="userInfoSection">
                <div class="stat-title">🔍 會員資訊</div>
                <div class="info-item">
                    <span class="info-label">會員ID:</span>
                    <span class="info-value" id="memberId">載入中...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">顯示名稱:</span>
                    <span class="info-value" id="displayName">載入中...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">會員等級:</span>
                    <span class="info-value" id="memberLevel">載入中...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">加入時間:</span>
                    <span class="info-value" id="joinDate">載入中...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">最後登入:</span>
                    <span class="info-value" id="lastLogin">載入中...</span>
                </div>
            </div>
            
            <!-- 會員統計 -->
            <div class="stat-card" id="memberStats" style="display: none;">
                <div class="stat-title">📊 會員統計</div>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="totalTasksCount">0</div>
                        <div class="stat-label">總任務數</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="completedTasksCount">0</div>
                        <div class="stat-label">已完成</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="loginCount">0</div>
                        <div class="stat-label">登入次數</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="completionRate">0%</div>
                        <div class="stat-label">完成率</div>
                    </div>
                </div>
            </div>
            
            <!-- 功能狀態 -->
            <div class="feature-list">
                <div class="stat-title">🛠️ 功能狀態</div>
                <div class="feature-item">
                    <div class="feature-icon">📝</div>
                    <div class="feature-text">任務管理</div>
                    <div class="feature-status">正常</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">🎤</div>
                    <div class="feature-text">語音識別</div>
                    <div class="feature-status">正常</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">⏰</div>
                    <div class="feature-text">任務提醒</div>
                    <div class="feature-status">正常</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">📱</div>
                    <div class="feature-text">LIFF APP</div>
                    <div class="feature-status">正常</div>
                </div>
            </div>
            
            <button class="close-btn" onclick="closeLiff()">關閉</button>
        </div>
    </div>

    <script>
        let userProfile = null;
        let memberData = null;
        
        // 初始化頁面
        document.addEventListener('DOMContentLoaded', function() {
            // 先檢查是否有會員登入 token
            checkMemberLogin();
        });
        
        // 檢查會員登入狀態
        function checkMemberLogin() {
            const authToken = getCookie('authToken') || localStorage.getItem('authToken');
            
            if (authToken) {
                // 驗證 token 並載入會員資料
                fetch('/api/member/profile', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.member) {
                        memberData = data.member;
                        showMemberProfile();
                    } else {
                        // token 無效，清除並顯示登入提示
                        clearAuthToken();
                        showLoginPrompt();
                    }
                })
                .catch(error => {
                    console.error('❌ 載入會員資料失敗:', error);
                    showLoginPrompt();
                });
            } else {
                // 沒有 token，嘗試 LIFF
                initializeLiff();
            }
        }
        
        // 初始化 LIFF
        function initializeLiff() {
            if (typeof liff !== 'undefined') {
                const liffId = '2007976732-1kEGwX34';
                
                liff.init({
                    liffId: liffId
                }).then(() => {
                    console.log('✅ LIFF 初始化成功');
                    
                    if (liff.isLoggedIn()) {
                        console.log('🐕 使用者已登入 LIFF');
                        loadUserProfile();
                    } else {
                        showLoginPrompt();
                    }
                }).catch((err) => {
                    console.error('❌ LIFF 初始化失敗:', err);
                    showLoginPrompt();
                });
            } else {
                console.log('📱 非 LIFF 環境');
                showLoginPrompt();
            }
        }
        
        // 載入使用者資料
        function loadUserProfile() {
            try {
                liff.getProfile().then(profile => {
                    userProfile = profile;
                    document.getElementById('userName').textContent = profile.displayName || '小汪的朋友';
                    document.getElementById('userId').textContent = profile.userId || 'N/A';
                    document.getElementById('displayName').textContent = profile.displayName || 'N/A';
                    
                    // 設定頭像
                    if (profile.pictureUrl) {
                        document.getElementById('userAvatar').innerHTML = `<img src="${profile.pictureUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                    }
                    
                    console.log('👤 使用者資料載入成功:', profile);
                }).catch(error => {
                    console.error('❌ 載入使用者資料失敗:', error);
                    showDefaultInfo();
                });
            } catch (error) {
                console.error('❌ 獲取使用者資料錯誤:', error);
                showDefaultInfo();
            }
            
            // 設定語言資訊
            const language = liff.getLanguage() || 'zh';
            document.getElementById('userLanguage').textContent = language === 'zh' ? '繁體中文' : language;
        }
        
        // 顯示預設資訊
        function showDefaultInfo() {
            document.getElementById('userName').textContent = '小汪的朋友';
            document.getElementById('userId').textContent = '訪客模式';
            document.getElementById('displayName').textContent = '匿名用戶';
            document.getElementById('userLanguage').textContent = '繁體中文';
        }
        
        // 顯示會員資料
        function showMemberProfile() {
            document.getElementById('loginPrompt').style.display = 'none';
            document.getElementById('userInfoSection').style.display = 'block';
            document.getElementById('memberStats').style.display = 'block';
            
            // 更新會員資料
            document.getElementById('userName').textContent = memberData.displayName;
            document.getElementById('memberId').textContent = memberData.memberId;
            document.getElementById('displayName').textContent = memberData.displayName;
            document.getElementById('memberLevel').textContent = getMemberLevelText(memberData.memberLevel);
            document.getElementById('joinDate').textContent = formatDate(memberData.createdAt);
            document.getElementById('lastLogin').textContent = formatDate(memberData.lastLoginAt);
            
            // 更新會員等級徽章
            const badge = document.getElementById('memberBadge');
            badge.textContent = getMemberLevelText(memberData.memberLevel);
            badge.className = `member-badge member-${memberData.memberLevel}`;
            badge.style.display = 'inline-block';
            
            // 顯示登出按鈕
            document.getElementById('logoutBtn').style.display = 'inline-block';
            
            // 設定頭像
            if (memberData.pictureUrl) {
                document.getElementById('userAvatar').innerHTML = `<img src="${memberData.pictureUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
            }
            
            // 更新統計資料
            document.getElementById('totalTasksCount').textContent = memberData.stats.totalTasks || 0;
            document.getElementById('completedTasksCount').textContent = memberData.stats.completedTasks || 0;
            document.getElementById('loginCount').textContent = memberData.stats.loginCount || 0;
            
            const completionRate = memberData.stats.totalTasks > 0 
                ? Math.round((memberData.stats.completedTasks / memberData.stats.totalTasks) * 100) 
                : 0;
            document.getElementById('completionRate').textContent = completionRate + '%';
            
            // 更新副標題
            document.getElementById('userSubtitle').textContent = `${getMemberLevelText(memberData.memberLevel)} - 小汪記記會員`;
        }
        
        // 顯示登入提示
        function showLoginPrompt() {
            document.getElementById('loginPrompt').style.display = 'block';
            document.getElementById('userInfoSection').style.display = 'none';
            document.getElementById('memberStats').style.display = 'none';
            document.getElementById('memberBadge').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            
            // 恢復預設顯示
            document.getElementById('userName').textContent = '小汪的朋友';
            document.getElementById('userSubtitle').textContent = '尚未登入會員';
        }
        
        // 會員登出
        function logoutMember() {
            if (confirm('確定要登出會員嗎？')) {
                clearAuthToken();
                showLoginPrompt();
                
                // 通知後端登出 (可選)
                fetch('/api/member/logout', {
                    method: 'POST'
                }).catch(error => {
                    console.error('❌ 登出請求失敗:', error);
                });
                
                console.log('👋 會員已登出');
            }
        }
        
        // 工具函數：獲取會員等級文字
        function getMemberLevelText(level) {
            const levels = {
                'basic': '基礎會員',
                'premium': '進階會員', 
                'vip': 'VIP會員'
            };
            return levels[level] || '基礎會員';
        }
        
        // 工具函數：格式化日期
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
        }
        
        // 工具函數：獲取 Cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        // 工具函數：清除認證 Token
        function clearAuthToken() {
            document.cookie = 'authToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
            localStorage.removeItem('authToken');
            sessionStorage.removeItem('authToken');
        }
        
        // 關閉 LIFF 視窗
        function closeLiff() {
            if (typeof liff !== 'undefined' && liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.close();
            }
        }
    </script>
</body>
</html>