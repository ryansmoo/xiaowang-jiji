<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ±ªè¨˜è¨˜ - å€‹äººå¸³æˆ¶</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #DDA368 0%, #F4D03F 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #DDA368 0%, #F4D03F 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid white;
            margin-bottom: 15px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .username {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .user-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            padding: 25px;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #DDA368;
        }
        
        .stat-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #DDA368;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .feature-list {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .feature-item:last-child {
            border-bottom: none;
        }
        
        .feature-icon {
            font-size: 20px;
            margin-right: 15px;
            width: 30px;
            text-align: center;
        }
        
        .feature-text {
            flex: 1;
            font-size: 16px;
            color: #333;
        }
        
        .feature-status {
            font-size: 12px;
            color: #28a745;
            background: #d4edda;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .close-btn {
            background: linear-gradient(135deg, #DDA368 0%, #F4D03F 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: bold;
        }
        
        .close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
        
        .user-info {
            background: #e3f2fd;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #2196f3;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info-label {
            color: #666;
            font-weight: 500;
        }
        
        .info-value {
            color: #333;
            font-weight: bold;
        }
        
        /* æœƒå“¡ç³»çµ±æ¨£å¼ */
        .member-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .member-basic {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .member-premium {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .member-vip {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .login-prompt {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .login-btn {
            background: #00C300;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            background: #00B300;
            transform: translateY(-1px);
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="profile-avatar" id="userAvatar">ğŸ•</div>
            <div class="username" id="userName">è¼‰å…¥ä¸­...
                <span class="member-badge member-basic" id="memberBadge" style="display: none;">åŸºç¤æœƒå“¡</span>
                <button class="logout-btn" id="logoutBtn" style="display: none;" onclick="logoutMember()">ç™»å‡º</button>
            </div>
            <div class="user-subtitle" id="userSubtitle">å°æ±ªè¨˜è¨˜çš„å¥½æœ‹å‹</div>
        </div>
        
        <div class="content">
            <!-- ç™»å…¥æç¤ºå€å¡Š -->
            <div class="login-prompt" id="loginPrompt" style="display: none;">
                <div style="font-size: 20px; margin-bottom: 10px;">ğŸ•</div>
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">æˆç‚ºå°æ±ªè¨˜è¨˜æœƒå“¡</div>
                <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                    ç™»å…¥å¾Œäº«å—å€‹äººåŒ–åŠŸèƒ½å’Œè³‡æ–™åŒæ­¥
                </div>
                <a href="/login" class="login-btn">ğŸ” ç«‹å³ç™»å…¥</a>
            </div>
            
            <!-- ç”¨æˆ¶è³‡è¨Šå€å¡Š -->
            <div class="user-info" id="userInfoSection">
                <div class="stat-title">ğŸ” æœƒå“¡è³‡è¨Š</div>
                <div class="info-item">
                    <span class="info-label">æœƒå“¡ID:</span>
                    <span class="info-value" id="memberId">è¼‰å…¥ä¸­...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">é¡¯ç¤ºåç¨±:</span>
                    <span class="info-value" id="displayName">è¼‰å…¥ä¸­...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æœƒå“¡ç­‰ç´š:</span>
                    <span class="info-value" id="memberLevel">è¼‰å…¥ä¸­...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">åŠ å…¥æ™‚é–“:</span>
                    <span class="info-value" id="joinDate">è¼‰å…¥ä¸­...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æœ€å¾Œç™»å…¥:</span>
                    <span class="info-value" id="lastLogin">è¼‰å…¥ä¸­...</span>
                </div>
            </div>
            
            <!-- æœƒå“¡çµ±è¨ˆ -->
            <div class="stat-card" id="memberStats" style="display: none;">
                <div class="stat-title">ğŸ“Š æœƒå“¡çµ±è¨ˆ</div>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="totalTasksCount">0</div>
                        <div class="stat-label">ç¸½ä»»å‹™æ•¸</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="completedTasksCount">0</div>
                        <div class="stat-label">å·²å®Œæˆ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="loginCount">0</div>
                        <div class="stat-label">ç™»å…¥æ¬¡æ•¸</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="completionRate">0%</div>
                        <div class="stat-label">å®Œæˆç‡</div>
                    </div>
                </div>
            </div>
            
            <!-- åŠŸèƒ½ç‹€æ…‹ -->
            <div class="feature-list">
                <div class="stat-title">ğŸ› ï¸ åŠŸèƒ½ç‹€æ…‹</div>
                <div class="feature-item">
                    <div class="feature-icon">ğŸ“</div>
                    <div class="feature-text">ä»»å‹™ç®¡ç†</div>
                    <div class="feature-status">æ­£å¸¸</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ğŸ¤</div>
                    <div class="feature-text">èªéŸ³è­˜åˆ¥</div>
                    <div class="feature-status">æ­£å¸¸</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">â°</div>
                    <div class="feature-text">ä»»å‹™æé†’</div>
                    <div class="feature-status">æ­£å¸¸</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ğŸ“±</div>
                    <div class="feature-text">LIFF APP</div>
                    <div class="feature-status">æ­£å¸¸</div>
                </div>
            </div>
            
            <button class="close-btn" onclick="closeLiff()">é—œé–‰</button>
        </div>
    </div>

    <script>
        let userProfile = null;
        let memberData = null;
        
        // åˆå§‹åŒ–é é¢
        document.addEventListener('DOMContentLoaded', function() {
            // å…ˆæª¢æŸ¥æ˜¯å¦æœ‰æœƒå“¡ç™»å…¥ token
            checkMemberLogin();
        });
        
        // æª¢æŸ¥æœƒå“¡ç™»å…¥ç‹€æ…‹
        function checkMemberLogin() {
            const authToken = getCookie('authToken') || localStorage.getItem('authToken');
            
            if (authToken) {
                // é©—è­‰ token ä¸¦è¼‰å…¥æœƒå“¡è³‡æ–™
                fetch('/api/member/profile', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.member) {
                        memberData = data.member;
                        showMemberProfile();
                    } else {
                        // token ç„¡æ•ˆï¼Œæ¸…é™¤ä¸¦é¡¯ç¤ºç™»å…¥æç¤º
                        clearAuthToken();
                        showLoginPrompt();
                    }
                })
                .catch(error => {
                    console.error('âŒ è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—:', error);
                    showLoginPrompt();
                });
            } else {
                // æ²’æœ‰ tokenï¼Œå˜—è©¦ LIFF
                initializeLiff();
            }
        }
        
        // åˆå§‹åŒ– LIFF
        function initializeLiff() {
            if (typeof liff !== 'undefined') {
                const liffId = '2007976732-1kEGwX34';
                
                liff.init({
                    liffId: liffId
                }).then(() => {
                    console.log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
                    
                    if (liff.isLoggedIn()) {
                        console.log('ğŸ• ä½¿ç”¨è€…å·²ç™»å…¥ LIFF');
                        loadUserProfile();
                    } else {
                        showLoginPrompt();
                    }
                }).catch((err) => {
                    console.error('âŒ LIFF åˆå§‹åŒ–å¤±æ•—:', err);
                    showLoginPrompt();
                });
            } else {
                console.log('ğŸ“± é LIFF ç’°å¢ƒ');
                showLoginPrompt();
            }
        }
        
        // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
        function loadUserProfile() {
            try {
                liff.getProfile().then(profile => {
                    userProfile = profile;
                    document.getElementById('userName').textContent = profile.displayName || 'å°æ±ªçš„æœ‹å‹';
                    document.getElementById('userId').textContent = profile.userId || 'N/A';
                    document.getElementById('displayName').textContent = profile.displayName || 'N/A';
                    
                    // è¨­å®šé ­åƒ
                    if (profile.pictureUrl) {
                        document.getElementById('userAvatar').innerHTML = `<img src="${profile.pictureUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                    }
                    
                    console.log('ğŸ‘¤ ä½¿ç”¨è€…è³‡æ–™è¼‰å…¥æˆåŠŸ:', profile);
                }).catch(error => {
                    console.error('âŒ è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™å¤±æ•—:', error);
                    showDefaultInfo();
                });
            } catch (error) {
                console.error('âŒ ç²å–ä½¿ç”¨è€…è³‡æ–™éŒ¯èª¤:', error);
                showDefaultInfo();
            }
            
            // è¨­å®šèªè¨€è³‡è¨Š
            const language = liff.getLanguage() || 'zh';
            document.getElementById('userLanguage').textContent = language === 'zh' ? 'ç¹é«”ä¸­æ–‡' : language;
        }
        
        // é¡¯ç¤ºé è¨­è³‡è¨Š
        function showDefaultInfo() {
            document.getElementById('userName').textContent = 'å°æ±ªçš„æœ‹å‹';
            document.getElementById('userId').textContent = 'è¨ªå®¢æ¨¡å¼';
            document.getElementById('displayName').textContent = 'åŒ¿åç”¨æˆ¶';
            document.getElementById('userLanguage').textContent = 'ç¹é«”ä¸­æ–‡';
        }
        
        // é¡¯ç¤ºæœƒå“¡è³‡æ–™
        function showMemberProfile() {
            document.getElementById('loginPrompt').style.display = 'none';
            document.getElementById('userInfoSection').style.display = 'block';
            document.getElementById('memberStats').style.display = 'block';
            
            // æ›´æ–°æœƒå“¡è³‡æ–™
            document.getElementById('userName').textContent = memberData.displayName;
            document.getElementById('memberId').textContent = memberData.memberId;
            document.getElementById('displayName').textContent = memberData.displayName;
            document.getElementById('memberLevel').textContent = getMemberLevelText(memberData.memberLevel);
            document.getElementById('joinDate').textContent = formatDate(memberData.createdAt);
            document.getElementById('lastLogin').textContent = formatDate(memberData.lastLoginAt);
            
            // æ›´æ–°æœƒå“¡ç­‰ç´šå¾½ç« 
            const badge = document.getElementById('memberBadge');
            badge.textContent = getMemberLevelText(memberData.memberLevel);
            badge.className = `member-badge member-${memberData.memberLevel}`;
            badge.style.display = 'inline-block';
            
            // é¡¯ç¤ºç™»å‡ºæŒ‰éˆ•
            document.getElementById('logoutBtn').style.display = 'inline-block';
            
            // è¨­å®šé ­åƒ
            if (memberData.pictureUrl) {
                document.getElementById('userAvatar').innerHTML = `<img src="${memberData.pictureUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
            }
            
            // æ›´æ–°çµ±è¨ˆè³‡æ–™
            document.getElementById('totalTasksCount').textContent = memberData.stats.totalTasks || 0;
            document.getElementById('completedTasksCount').textContent = memberData.stats.completedTasks || 0;
            document.getElementById('loginCount').textContent = memberData.stats.loginCount || 0;
            
            const completionRate = memberData.stats.totalTasks > 0 
                ? Math.round((memberData.stats.completedTasks / memberData.stats.totalTasks) * 100) 
                : 0;
            document.getElementById('completionRate').textContent = completionRate + '%';
            
            // æ›´æ–°å‰¯æ¨™é¡Œ
            document.getElementById('userSubtitle').textContent = `${getMemberLevelText(memberData.memberLevel)} - å°æ±ªè¨˜è¨˜æœƒå“¡`;
        }
        
        // é¡¯ç¤ºç™»å…¥æç¤º
        function showLoginPrompt() {
            document.getElementById('loginPrompt').style.display = 'block';
            document.getElementById('userInfoSection').style.display = 'none';
            document.getElementById('memberStats').style.display = 'none';
            document.getElementById('memberBadge').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            
            // æ¢å¾©é è¨­é¡¯ç¤º
            document.getElementById('userName').textContent = 'å°æ±ªçš„æœ‹å‹';
            document.getElementById('userSubtitle').textContent = 'å°šæœªç™»å…¥æœƒå“¡';
        }
        
        // æœƒå“¡ç™»å‡º
        function logoutMember() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºæœƒå“¡å—ï¼Ÿ')) {
                clearAuthToken();
                showLoginPrompt();
                
                // é€šçŸ¥å¾Œç«¯ç™»å‡º (å¯é¸)
                fetch('/api/member/logout', {
                    method: 'POST'
                }).catch(error => {
                    console.error('âŒ ç™»å‡ºè«‹æ±‚å¤±æ•—:', error);
                });
                
                console.log('ğŸ‘‹ æœƒå“¡å·²ç™»å‡º');
            }
        }
        
        // å·¥å…·å‡½æ•¸ï¼šç²å–æœƒå“¡ç­‰ç´šæ–‡å­—
        function getMemberLevelText(level) {
            const levels = {
                'basic': 'åŸºç¤æœƒå“¡',
                'premium': 'é€²éšæœƒå“¡', 
                'vip': 'VIPæœƒå“¡'
            };
            return levels[level] || 'åŸºç¤æœƒå“¡';
        }
        
        // å·¥å…·å‡½æ•¸ï¼šæ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-TW') + ' ' + date.toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'});
        }
        
        // å·¥å…·å‡½æ•¸ï¼šç²å– Cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
        
        // å·¥å…·å‡½æ•¸ï¼šæ¸…é™¤èªè­‰ Token
        function clearAuthToken() {
            document.cookie = 'authToken=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
            localStorage.removeItem('authToken');
            sessionStorage.removeItem('authToken');
        }
        
        // é—œé–‰ LIFF è¦–çª—
        function closeLiff() {
            if (typeof liff !== 'undefined' && liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.close();
            }
        }
    </script>
</body>
</html>